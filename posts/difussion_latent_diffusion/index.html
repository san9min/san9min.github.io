<!DOCTYPE html>
<html lang="ko"><head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Sangmin Blog | Difussion : Latent Diffusion</title>
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
  
  <link rel="stylesheet"
     href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link rel="stylesheet" href="../../assets/styles/main.css">
  
<link rel="icon" type="image/png" href="/assets/favicon.png" sizes="32x32">
</head><body>
  <main class="article">
    <h1>Difussion : Latent Diffusion</h1>
    <div class="meta">Feb 7, 2023 Â· 20 min read</div>
    <img class="hero" src="../..//images/difussion_latent_diffusion/thumbnail.png" alt="cover image">
    <h2><strong>High-Resolution Image Synthesis with Latent Diffusion Models</strong></h2>
<h3>Stable Diffusion</h3>
<p>ğŸ“„ <a href="https://arxiv.org/abs/2112.10752">High-Resolution Image Synthesis with Latent Diffusion Models</a></p>
<p>ğŸ”— <a href="https://github.com/CompVis/stable-diffusion">https://github.com/CompVis/stable-diffusion</a></p>
<p>Stable Diffusionì˜ ê¸°ë°˜ ë…¼ë¬¸ìœ¼ë¡œ, í•µì‹¬ ê°œë…ì€ ì•„ë˜ì™€ ê°™ë‹¤.</p>
<ul>
<li><code>Latent Diffusion Model</code></li>
<li><code>Cross-Attention based Conditioning</code></li>
<li><code>text to image</code></li>
</ul>
<p>pixcelì´ ì•„ë‹Œ latent spaceì—ì„œ diffusionì„ ìˆ˜í–‰í•¨ìœ¼ë¡œì¨ computational costë¥¼ ë§ì´ ì¤„ì˜€ë‹¤. ê·¸ëŸ°ë° ë‚œ ì´ ëª¨ë¸ì´ ë” ë§¤ë ¥ì ì¸ ë¶€ë¶„ì€ cross attentionìœ¼ë¡œ generalí•œ conditioning inputì„ ë°›ì•„ë“¤ ì¼ìˆ˜ ìˆëŠ” êµ¬ì¡°ì˜€ë‹¤ëŠ” ì ì´ë‹¤. ì´ë¡œì¨ text ë¡œë„ gudienceë¥¼ ì¤„ ìˆ˜ ìˆë‹¤ëŠ” ì ì´ ë§¤ìš° ê°ë™ì´ì—ˆë‹¤..</p>
<h3>ğŸ’ Guided Diffusionì´ë€?</h3>
<p>Stable Diffusion êµ¬ì¡°ë¥¼ ì´í•´í•˜ë ¤ë©´ ë¨¼ì € Guided(conditional) Diffusionì´ ë¬´ì—‡ì¸ì§€ ì•Œì•„ì•¼í•œë‹¤. 
Sampling ê³¼ì •ì— conditionì„ ë„£ì–´ì„œ ìƒì„±ë˜ëŠ” sampleë“¤ì„ ì˜ë„í•œ ë°©í–¥ìœ¼ë¡œ ìœ ë„í•  ìˆ˜ ìˆëŠ” ë°©ì‹ì´ë‹¤. 
ì¦‰ prior distribution p(x)ì— condition yë¥¼ ì¤˜ì„œ p(x|y)ë¥¼ ëª¨ë¸ë§í•˜ëŠ” ê²ƒì´ë‹¤. Guided diffusionì€ diffusion stepë§ˆë‹¤ condition infoë¥¼ ë°˜ì˜í•˜ëŠ” ë°©ì‹ì´ë¼ ìƒê°í•˜ë©´ ëœë‹¤.</p>
<p>$$
p_{\theta}(x_{0:T}|y) = p_{\theta}(x_T)\Pi_{t=1}^Tp_{\theta}(x_{t-1}|x_t,y)
$$</p>
<p>ì´ ìˆ˜ì‹ êµ¬ì¡° ë•ë¶„ì— í…ìŠ¤íŠ¸ë‚˜ ì´ë¯¸ì§€ ë“±ì˜ ì™¸ë¶€ ì…ë ¥ì„ conditionìœ¼ë¡œ ì¤„ ìˆ˜ ìˆë‹¤.</p>
<hr>
<h3>ğŸ”» Gradient ê´€ì ì˜ Guidance</h3>
<p>Diffusion modelì€ SDE(ì¦‰, í™•ë¥  íë¦„)ë¡œ í‘œí˜„í•  ìˆ˜ ìˆë‹¤.</p>
<p>ê·¸ë˜ì„œ guided diffusion modelì€ $\nabla \log p_{\theta}(x_t|y)$ë¥¼ í•™ìŠµí•´ì•¼ í•œë‹¤.</p>
<p>Bayes Ruleì„ ì ìš©í•˜ë©´ ì•„ë˜ì²˜ëŸ¼ ë¶„ë¦¬ëœë‹¤.</p>
<p>$$
\nabla_{x_t} \log p_{\theta}(x_t|y) = \nabla_{x_t} \log (\frac{p_{\theta}(y|x_t)p(x_t)}{p_{\theta}(y)}) \ = \nabla_{x_t} \log p_{\theta}(x_t) + \nabla_{x_t} \log p_{\theta}(y|x_t)
$$</p>
<p>ì—¬ê¸°ì„œ ë‘ ë²ˆì§¸ í•­ì— ìŠ¤ì¹¼ë¼ ê°€ì¤‘ì¹˜ Î³ë¥¼ ê³±í•œ ê²ƒì´ ë°”ë¡œ <strong>Classifier Guidance</strong>ì´ë‹¤.</p>
<p>$$
\nabla_{x_t} \log p_{\theta}(x_t|y) =\nabla_{x_t} \log p_{\theta}(x_t) + \gamma \cdot\nabla_{x_t} \log p_{\theta}(y|x_t)
$$</p>
<hr>
<h3>ğŸŒ€ Classifier Free guidance</h3>
<p>ğŸ“„ <a href="https://arxiv.org/abs/2207.12598">Classifier-Free Diffusion Guidance</a></p>
<p>Classifierë¥¼ ë³„ë„ë¡œ ì‚¬ìš©í•˜ì§€ ì•Šê³  ê°™ì€ ëª¨ë¸ë¡œ conditionalê³¼ unconditionalì„ ëª¨ë‘ í•™ìŠµí•˜ëŠ” ë°©ì‹ì´ë‹¤.
Bayes Ruleì„ ë‹¤ì‹œ ì ìš©í•˜ë©´ ì•„ë˜ì™€ ê°™ì€ í˜•íƒœë¡œ ì •ë¦¬ëœë‹¤.</p>
<p>$$
\nabla_{x_t} \log p_{\theta}(x_t|y) = (1-\gamma)\nabla_{x_t} \log p_{\theta}(x_t) + \gamma \cdot\nabla_{x_t} \log p_{\theta}(x_t|y)
$$</p>
<p>ì´ ê°œë…ì€ Stable Diffusionì—ì„œë„ ë‹¤ìŒê³¼ ê°™ì´ í™œìš©ëœë‹¤.</p>
<p>$$\tilde{\epsilon}(z_\lambda,c) = (1+w)\epsilon_\theta(z_\lambda,c) - w\epsilon_\theta(z_\lambda)$$</p>
<aside>
ì—¬ê¸°ì„œ unconditional termì€ 0ì„ embedding í•˜ëŠ” ë°©ì‹ ë“±ìœ¼ë¡œ ì²˜ë¦¬í•´ì„œ, `í•˜ë‚˜ì˜ ëª¨ë¸`ë¡œ ëª¨ë‘ ë‹¤ë£° ìˆë„ë¡ `conditionalê³¼ unconditional ì„ ë™ì‹œì— í•™ìŠµ` í•œë‹¤.

</aside>

<h3>â­ Latent Diffusionì˜ conditioning</h3>
<blockquote>
<p><code>Classifier free guidance</code></p>
</blockquote>
<p>Latent Diffusionì—ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì€ ë°©ì‹ìœ¼ë¡œ conditional noise predictionì„ ê³„ì‚°í•œë‹¤.</p>
<figure class="eq">
$$\epsilon_\theta(x_t,c) = s\epsilon_{cond}(x_t,c) + (1-s)\epsilon_{cond}(x_t,c_u)$$
</figure>


<p>ì—¬ê¸°ì„œ $c_u$ëŠ” empty promptì— ëŒ€í•œ ì¡°ê±´(conditional embedding)ì´ê³ , $s$ëŠ” guidance strengthì´ë‹¤.</p>
<h3>ğŸ— Architecture</h3>
<p><img src="/images/difussion_latent_diffusion/01.webp" alt="Untitled"></p>
<p><code>CLIP Text</code></p>
<ul>
<li>Text understanding component for Text Encoding</li>
<li>Transformer language model</li>
</ul>
<p><code>U-Net</code> + <code>Scheduler</code></p>
<ul>
<li>Information creator (í•µì‹¬ diffusion ì—°ì‚°)</li>
<li>latent space â‡’ faster</li>
</ul>
<p><code>Autoencoder Decoder</code></p>
<ul>
<li>Image Decoder : ìµœì¢… latent â‡’ ì´ë¯¸ì§€ ë³µì›</li>
</ul>
<h3>ğŸšª ë‚˜ê°€ë©°</h3>
<p>ë‹¨ìˆœí•œ T2I ëª¨ë¸ì„ ë„˜ì–´ì„œ,
í…ìŠ¤íŠ¸ë¼ëŠ” ì¼ë°˜ì ì¸ ì¡°ê±´ì„ í™œìš©í•´ íš¨ìœ¨ì ìœ¼ë¡œ ê³ í•´ìƒë„ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ëŠ” Latent Diffusionì˜ íŒ¨ëŸ¬ë‹¤ì„ì„ ì •ë¦½í•œ ë…¼ë¬¸ì´ë‹¤.</p>

    <section class="related">
        <div class="related-head">
          <h2>Related posts</h2>
          <a class="all-link" href="../../">Browse all articles&nbsp;â†’</a>
        </div>
        <div class="related-list">
      <a class="card mini" href="../../posts/Diffusion_DDIM/">
        <img class="thumb" src="../../images/diffusion_ddim/thumbnail.png" alt="">
        <div class="card-body">
        
          <h3 class="card-title">Diffusion : DDIM</h3>
          <span class="arrow">â†—</span>
          <div class="meta">Jan 31, 2023 Â· 20 min</div>
        </div>
      </a>
      <a class="card mini" href="../../posts/Diffusion_DDPM/">
        <img class="thumb" src="../..//images/diffusion_ddpm/thumbnail.jpg" alt="">
        <div class="card-body">
        
          <h3 class="card-title">Diffusion : DDPM</h3>
          <span class="arrow">â†—</span>
          <div class="meta">Jan 22, 2023 Â· 20 min</div>
        </div>
      </a>
      <a class="card mini" href="../../posts/Diffusion_kickoff/">
        <img class="thumb" src="../..//images/diffusion_kickoff/thumbnail.png" alt="">
        <div class="card-body">
        
          <h3 class="card-title">Diffusion : Kick-off</h3>
          <span class="arrow">â†—</span>
          <div class="meta">Jan 15, 2023 Â· 15 min</div>
        </div>
      </a></div>
      </section> 
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>
<script>
window.MathJax = {
  tex: {
    inlineMath:  [['$', '$'], ['\\(', '\\)']],
    displayMath: [['$$', '$$'], ['\\[', '\\]']],
    processEscapes: true,
    processEnvironments: true
  },

  chtml: {
    linebreaks: { automatic: true, width: "match" }  // ë˜ëŠ” width: 80
  },

  options: {
    renderActions: { addMenu: [] }   // ìš°í´ë¦­ ë©”ë‰´ ì œê±°
  }
};
</script>
<script id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
  <script src="../../assets/js/main.js" defer></script>
</body></html>