<!DOCTYPE html>
<html lang="ko"><head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Sangmin Blog | Difussion : Latent Diffusion</title>
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
  
  <link rel="stylesheet"
     href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link rel="stylesheet" href="../../assets/styles/main.css">
  
<link rel="icon" type="image/png" href="/assets/favicon.png" sizes="32x32">
</head><body>
  <main class="article">
    <h1>Difussion : Latent Diffusion</h1>
    <div class="meta">Feb 7, 2023 · 20 min read</div>
    <img class="hero" src="../..//images/difussion_latent_diffusion/thumbnail.png" alt="cover image">
    <h2><strong>High-Resolution Image Synthesis with Latent Diffusion Models</strong></h2>
<h3>Stable Diffusion</h3>
<p>📄 <a href="https://arxiv.org/abs/2112.10752">High-Resolution Image Synthesis with Latent Diffusion Models</a></p>
<p>🔗 <a href="https://github.com/CompVis/stable-diffusion">https://github.com/CompVis/stable-diffusion</a></p>
<p>Stable Diffusion의 기반 논문으로, 핵심 개념은 아래와 같다.</p>
<ul>
<li><code>Latent Diffusion Model</code></li>
<li><code>Cross-Attention based Conditioning</code></li>
<li><code>text to image</code></li>
</ul>
<p>pixcel이 아닌 latent space에서 diffusion을 수행함으로써 computational cost를 많이 줄였다. 그런데 난 이 모델이 더 매력적인 부분은 cross attention으로 general한 conditioning input을 받아들 일수 있는 구조였다는 점이다. 이로써 text 로도 gudience를 줄 수 있다는 점이 매우 감동이었다..</p>
<h3>💁 Guided Diffusion이란?</h3>
<p>Stable Diffusion 구조를 이해하려면 먼저 Guided(conditional) Diffusion이 무엇인지 알아야한다. 
Sampling 과정에 condition을 넣어서 생성되는 sample들을 의도한 방향으로 유도할 수 있는 방식이다. 
즉 prior distribution p(x)에 condition y를 줘서 p(x|y)를 모델링하는 것이다. Guided diffusion은 diffusion step마다 condition info를 반영하는 방식이라 생각하면 된다.</p>
<p>$$
p_{\theta}(x_{0:T}|y) = p_{\theta}(x_T)\Pi_{t=1}^Tp_{\theta}(x_{t-1}|x_t,y)
$$</p>
<p>이 수식 구조 덕분에 텍스트나 이미지 등의 외부 입력을 condition으로 줄 수 있다.</p>
<hr>
<h3>🔻 Gradient 관점의 Guidance</h3>
<p>Diffusion model은 SDE(즉, 확률 흐름)로 표현할 수 있다.</p>
<p>그래서 guided diffusion model은 $\nabla \log p_{\theta}(x_t|y)$를 학습해야 한다.</p>
<p>Bayes Rule을 적용하면 아래처럼 분리된다.</p>
<p>$$
\nabla_{x_t} \log p_{\theta}(x_t|y) = \nabla_{x_t} \log (\frac{p_{\theta}(y|x_t)p(x_t)}{p_{\theta}(y)}) \ = \nabla_{x_t} \log p_{\theta}(x_t) + \nabla_{x_t} \log p_{\theta}(y|x_t)
$$</p>
<p>여기서 두 번째 항에 스칼라 가중치 γ를 곱한 것이 바로 <strong>Classifier Guidance</strong>이다.</p>
<p>$$
\nabla_{x_t} \log p_{\theta}(x_t|y) =\nabla_{x_t} \log p_{\theta}(x_t) + \gamma \cdot\nabla_{x_t} \log p_{\theta}(y|x_t)
$$</p>
<hr>
<h3>🌀 Classifier Free guidance</h3>
<p>📄 <a href="https://arxiv.org/abs/2207.12598">Classifier-Free Diffusion Guidance</a></p>
<p>Classifier를 별도로 사용하지 않고 같은 모델로 conditional과 unconditional을 모두 학습하는 방식이다.
Bayes Rule을 다시 적용하면 아래와 같은 형태로 정리된다.</p>
<p>$$
\nabla_{x_t} \log p_{\theta}(x_t|y) = (1-\gamma)\nabla_{x_t} \log p_{\theta}(x_t) + \gamma \cdot\nabla_{x_t} \log p_{\theta}(x_t|y)
$$</p>
<p>이 개념은 Stable Diffusion에서도 다음과 같이 활용된다.</p>
<p>$$\tilde{\epsilon}(z_\lambda,c) = (1+w)\epsilon_\theta(z_\lambda,c) - w\epsilon_\theta(z_\lambda)$$</p>
<aside>
여기서 unconditional term은 0을 embedding 하는 방식 등으로 처리해서, `하나의 모델`로 모두 다룰 있도록 `conditional과 unconditional 을 동시에 학습` 한다.

</aside>

<h3>⭐ Latent Diffusion의 conditioning</h3>
<blockquote>
<p><code>Classifier free guidance</code></p>
</blockquote>
<p>Latent Diffusion에서는 다음과 같은 방식으로 conditional noise prediction을 계산한다.</p>
<figure class="eq">
$$\epsilon_\theta(x_t,c) = s\epsilon_{cond}(x_t,c) + (1-s)\epsilon_{cond}(x_t,c_u)$$
</figure>


<p>여기서 $c_u$는 empty prompt에 대한 조건(conditional embedding)이고, $s$는 guidance strength이다.</p>
<h3>🏗 Architecture</h3>
<p><img src="/images/difussion_latent_diffusion/01.webp" alt="Untitled"></p>
<p><code>CLIP Text</code></p>
<ul>
<li>Text understanding component for Text Encoding</li>
<li>Transformer language model</li>
</ul>
<p><code>U-Net</code> + <code>Scheduler</code></p>
<ul>
<li>Information creator (핵심 diffusion 연산)</li>
<li>latent space ⇒ faster</li>
</ul>
<p><code>Autoencoder Decoder</code></p>
<ul>
<li>Image Decoder : 최종 latent ⇒ 이미지 복원</li>
</ul>
<h3>🚪 나가며</h3>
<p>단순한 T2I 모델을 넘어서,
텍스트라는 일반적인 조건을 활용해 효율적으로 고해상도 이미지를 생성하는 Latent Diffusion의 패러다임을 정립한 논문이다.</p>

    <section class="related">
        <div class="related-head">
          <h2>Related posts</h2>
          <a class="all-link" href="../../">Browse all articles&nbsp;→</a>
        </div>
        <div class="related-list">
      <a class="card mini" href="../../posts/Diffusion_DDIM/">
        <img class="thumb" src="../../images/diffusion_ddim/thumbnail.png" alt="">
        <div class="card-body">
        
          <h3 class="card-title">Diffusion : DDIM</h3>
          <span class="arrow">↗</span>
          <div class="meta">Jan 31, 2023 · 20 min</div>
        </div>
      </a>
      <a class="card mini" href="../../posts/Diffusion_DDPM/">
        <img class="thumb" src="../..//images/diffusion_ddpm/thumbnail.jpg" alt="">
        <div class="card-body">
        
          <h3 class="card-title">Diffusion : DDPM</h3>
          <span class="arrow">↗</span>
          <div class="meta">Jan 22, 2023 · 20 min</div>
        </div>
      </a>
      <a class="card mini" href="../../posts/Diffusion_kickoff/">
        <img class="thumb" src="../..//images/diffusion_kickoff/thumbnail.png" alt="">
        <div class="card-body">
        
          <h3 class="card-title">Diffusion : Kick-off</h3>
          <span class="arrow">↗</span>
          <div class="meta">Jan 15, 2023 · 15 min</div>
        </div>
      </a></div>
      </section> 
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>
<script>
window.MathJax = {
  tex: {
    inlineMath:  [['$', '$'], ['\\(', '\\)']],
    displayMath: [['$$', '$$'], ['\\[', '\\]']],
    processEscapes: true,
    processEnvironments: true
  },

  chtml: {
    linebreaks: { automatic: true, width: "match" }  // 또는 width: 80
  },

  options: {
    renderActions: { addMenu: [] }   // 우클릭 메뉴 제거
  }
};
</script>
<script id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
  <script src="../../assets/js/main.js" defer></script>
</body></html>